const firebaseConfig={apiKey:"AIzaSyBhfQ1Wf5JEy6sOU4ExXboRI4Ir4y_aKZw",authDomain:"easy-chatroom.firebaseapp.com",databaseURL:"https://easy-chatroom-default-rtdb.firebaseio.com",projectId:"easy-chatroom",storageBucket:"easy-chatroom.firebasestorage.app",messagingSenderId:"985049198428",appId:"1:985049198428:web:d0eb7e2de39887710c9b99",measurementId:"G-QDESJ2WR42"};firebase.initializeApp(firebaseConfig);const messaging=firebase.messaging(),db=firebase.database();let deviceId=null;(async()=>{deviceId=await generateDeviceId()})();const swearWords=["fuck","shit","bitch","asshole","bastard","dick","cunt","puta","mierda","pendejo","co√±o","cabron","gilipollas","porra","caralho","merda","puta","fdp","otario","putangina","gago","tangina","ulol","bobo","bwisit","putang ina"],style=document.createElement("style");style.innerHTML="\n  .reaction-tray {\n    display: none;\n    position: absolute;\n    background: #222;\n    padding: 6px 8px;\n    border-radius: 10px;\n    font-size: 18px;\n    top: -45px;\n    left: 0;\n    z-index: 10;\n    white-space: nowrap;\n    overflow-x: auto;\n    max-width: 100%;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);\n  }\n  .reaction-tray::-webkit-scrollbar {\n    height: 6px;\n  }\n  .reaction-tray::-webkit-scrollbar-thumb {\n    background: #444;\n    border-radius: 3px;\n  }\n  .reaction-tray button {\n    display: inline-block;\n    margin: 0 4px;\n    font-size: 20px;\n    background: none;\n    border: none;\n    cursor: pointer;\n  }\n",document.head.appendChild(style);const userAvatars={};let typingTimeout,globalDevs=[],roomAdmins=[],roomModerators=[],notificationsEnabled=!1,notificationStack=[],notificationTimer=null,roomUsers={},userListReady=!1,pendingMessages=[],messageTimestamps=[],isBlocked=!1,username=null,roomCode=null,clientId="_"+Math.random().toString(36).substr(2,9),lastActivity=Date.now(),gr8stg="";const STATIC_ROOM="050BBB66HH",MAX_MESSAGES=250,sound=new Audio("sounds/beep.mp3");let mediaRecorder;sound.volume=.3;let recordingTimer,audioChunks=[],isRecording=!1,isRoomAdmin=!1,isRegisterMode=!1;async function generateDeviceId(){const e=navigator.userAgent+screen.width+screen.height;return"_"+(await sha256(e)).substr(0,20)}function sha256(e){const t=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",t).then((e=>Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("")))}function toggleNotifications(){"granted"!==Notification.permission?Notification.requestPermission().then((e=>{"granted"===e&&(notificationsEnabled=!0,localStorage.setItem("notifications_enabled","true"),document.getElementById("notifToggleBtn").innerText="üîï Disable Notifications")})):(notificationsEnabled=!notificationsEnabled,localStorage.setItem("notifications_enabled",notificationsEnabled?"true":"false"),document.getElementById("notifToggleBtn").innerText=notificationsEnabled?"üîï Disable Notifications":"üîî Enable Notifications")}function toggleAuthMode(){isRegisterMode=!isRegisterMode,document.getElementById("authTitle").innerText=isRegisterMode?"Register":"Login",document.getElementById("authPasswordConfirm").style.display=isRegisterMode?"block":"none",document.getElementById("authDescription").style.display=isRegisterMode?"block":"none",document.getElementById("authAvatar").style.display=isRegisterMode?"block":"none",document.getElementById("authAvatarPreview").style.display="none",document.getElementById("authSubmitBtn").innerText=isRegisterMode?"Register":"Login",document.getElementById("authError").style.display="none"}function previewAvatar(){const e=document.getElementById("authAvatar");if(!e.files.length)return;const t=new FileReader;t.onloadend=()=>{document.getElementById("authAvatarPreview").src=t.result,document.getElementById("authAvatarPreview").style.display="block"},t.readAsDataURL(e.files[0])}async function submitAuth(){const e=document.getElementById("authUsername").value.trim(),t=document.getElementById("authPassword").value.trim(),n=document.getElementById("authPasswordConfirm").value.trim(),o=document.getElementById("authDescription").value.trim(),s=document.getElementById("authAvatar"),a=document.getElementById("authError");if(a.style.display="none",!e||!t)return a.innerText="Please fill in all fields.",void(a.style.display="block");const r=sanitizeUsername(e),i=db.ref(`auth/${r}`),d=await i.get();if(isRegisterMode){if(d.exists())return a.innerText="Username already exists.",void(a.style.display="block");if(t!==n)return a.innerText="Passwords do not match.",void(a.style.display="block");const r=await sha256(t);window.passwordHash=r,localStorage.setItem("2048_token",r);const l=await generateDeviceId();if(s.files.length){const n=s.files[0],a=new FileReader;a.onloadend=async()=>{const n=a.result.split(",")[1];await i.set({username:e,passwordHash:s,description:o||"",avatarBase64:n,role:"user",deviceId:l,usernameHistory:[e],lastChanged:Date.now()}),username=e,userDescription=o,avatarBase64=n,role="user";const s=await sha256(t);localStorage.setItem("2048_token",s),localStorage.setItem("2048_user",e),startAfterAuth()},a.readAsDataURL(n)}else{await i.set({username:e,passwordHash:n,description:o||"",avatarBase64:"",role:"user",deviceId:l,usernameHistory:[e],lastChanged:Date.now()}),username=e,userDescription=o,avatarBase64="",role="user";const n=await sha256(t);localStorage.setItem("2048_token",n),localStorage.setItem("2048_user",e),startAfterAuth()}}else{if(!d.exists())return a.innerText="Account not found.",void(a.style.display="block");const n=d.val();if(await sha256(t)!==n.passwordHash)return a.innerText="Incorrect password.",void(a.style.display="block");username=e,n.description&&(userDescription=n.description),n.avatarBase64&&(avatarBase64=n.avatarBase64),n.role?role=n.role:role="user";const o=await sha256(t);localStorage.setItem("2048_token",o),localStorage.setItem("2048_user",e),startAfterAuth()}}async function saveNewUser(e,t,n,o,s){const a=db.ref(`auth/${sanitizeUsername(e)}`),r={username:e,passwordHash:t,role:"user",deviceId:n,description:s||"",avatarBase64:o||"",usernameHistory:[e],lastChanged:Date.now()};await a.set(r),username=e,o=r.avatarBase64,userDescription=r.description,startAfterAuth()}async function startAfterAuth(){const e=sanitizeUsername(username),t=db.ref(`auth/${e}`),n=await t.get();if(n.exists()){const e=n.val();if(username=e.username,userDescription=e.description||"",avatarBase64=e.avatarBase64||"",role=e.role||"user",avatarBase64){const e=document.getElementById("sidebarAvatarPreview");e.src="data:image/png;base64,"+avatarBase64,e.style.display="block"}}else console.warn("User profile not found in auth database.");await loadRoomRoles(),showScreen("mainApp"),history.replaceState({screen:"mainApp"},"")}function toggleRecording(){isRecording?stopRecording():navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{mediaRecorder=new MediaRecorder(e),mediaRecorder.start(),isRecording=!0,document.getElementById("recordBtn").innerText="‚èπÔ∏è",audioChunks=[],mediaRecorder.ondataavailable=e=>audioChunks.push(e.data),mediaRecorder.onstop=()=>{clearTimeout(recordingTimer);const e=new Blob(audioChunks,{type:"audio/webm"}),t=new FileReader;t.onloadend=()=>{const e=t.result.split(",")[1],n=db.ref().push().key;db.ref(`rooms/${roomCode}/messages/${n}`).set({msg:"[Voice message]",audioBase64:e,sender:username,senderId:clientId,timestamp:Date.now()})},t.readAsDataURL(e)},recordingTimer=setTimeout((()=>{mediaRecorder&&isRecording&&stopRecording()}),2e4)})).catch((e=>{alert("Microphone permission denied.")}))}function stopRecording(){mediaRecorder&&isRecording&&(mediaRecorder.stop(),isRecording=!1,document.getElementById("recordBtn").innerText="üéôÔ∏è")}function sanitizeUsername(e){return e.replace(/[.#$\[\]]/g,"_")}function submitProfile(){const e=document.getElementById("profileUsernameInput").value.trim(),t=document.getElementById("profileDescriptionInput").value.trim(),n=document.getElementById("profileError");if(!e||!t)return n.innerText="Please enter both a username and a description.",void(n.style.display="block");const o=sanitizeUsername(e),s=db.ref(`profiles/${o}`);s.once("value").then((o=>{if(o.exists())n.innerText="‚ùå Username already taken.",n.style.display="block";else{const o={username:e,description:t,lastChanged:Date.now(),usernameHistory:[e]};s.set(o,(o=>{o?(console.error("Failed to save profile:",o),n.innerText="‚ö†Ô∏è Failed to save profile. Try again.",n.style.display="block"):(localStorage.setItem("chat_username",e),localStorage.setItem("profile_description",t),username=e,showScreen("mainApp"),history.replaceState({screen:"mainApp"},""))}))}})).catch((e=>{console.error("Error checking username:",e),n.innerText="‚ö†Ô∏è Could not check username. Try again.",n.style.display="block"}))}function saveProfile(e,t,n){const o=Date.now(),s=[e];db.ref(`profiles/${n}`).set({username:e,description:t,lastChanged:o,usernameHistory:s}),showScreen("mainApp"),s.replaceState({screen:"mainApp"},"")}function generateRoom(){roomCode=genRoomCode(),db.ref("rooms/"+roomCode).set({active:!0,created:Date.now()}),startChat()}function joinRoom(){const e=roomCode||document.getElementById("roomCodeInput").value.trim().toUpperCase();if(!e)return alert("Enter a valid room code");roomCode=e,roomCode!==STATIC_ROOM?db.ref("rooms/"+roomCode).get().then((e=>{e.exists()&&!1!==e.val().active?startChat():alert("Room doesn't exist or is inactive.")})):showScreen("passwordScreen")}async function startChat(){if(!roomCode||!username)return alert("Missing room or user information."),showScreen("mainApp")&&history.replaceState({screen:"mainApp"},"");listenForPauseState(),listenForUserList(),await loadRoomRoles(),listenForAnnouncement();const e=sanitizeUsername(username),t=db.ref(`users/${roomCode}/${e}`),n={username:username,online:!0,lastOnline:firebase.database.ServerValue.TIMESTAMP};t.set(n,(t=>{if(t)return alert("Failed to register user into room."),showScreen("mainApp")&&history.replaceState({screen:"mainApp"},"");const n=document.getElementById("sidebarAvatarPreview");avatarBase64&&(n.src="data:image/png;base64,"+avatarBase64,n.style.display="block"),document.getElementById("userDisplay").innerHTML=`${username} ${getRoleTag(e)}`,document.getElementById("roomDisplay").innerText=roomCode===STATIC_ROOM?"No room code available for private rooms":roomCode,updateAnnouncementVisibility();const o=db.ref().push().key;db.ref(`rooms/${roomCode}/messages/${o}`).set({msg:`${username} is online`,sender:"system",senderId:"system",timestamp:Date.now()}),showScreen("chatScreen"),document.getElementById("announcementArea").addEventListener("click",(e=>{3!==e.detail||"admin"!==role&&"dev"!==role||confirm("Remove this announcement?")&&db.ref(`rooms/${roomCode}/announcement`).remove().then((()=>{document.getElementById("announcementArea").innerText=""}))})),listenForMessages(),listenForTyping(),startInactivityTimer(),trackPresence(),watchProfileChanges(),watchMuteStatus(),startSidebarSyncLoop();const s=()=>{loadRoomRoles().then((()=>{renderUserLists(roomUsers),updateAnnouncementVisibility()}))};db.ref("auth").on("child_changed",s),db.ref("auth").on("child_added",s)}))}function updateAnnouncementVisibility(){const e=document.getElementById("addAnnouncementBtn");"admin"===role||"dev"===role?e.style.display="block":e.style.display="none"}function watchProfileChanges(){const e=sanitizeUsername(username);db.ref(`auth/${e}`).on("value",(e=>{if(!e.exists())return;const t=e.val();if(userDescription=t.description||"",avatarBase64=t.avatarBase64||"",role=t.role||"user",avatarBase64){const e=document.getElementById("sidebarAvatarPreview");e.src.includes(avatarBase64)||(e.src="data:image/png;base64,"+avatarBase64,e.style.display="block")}renderUserLists(roomUsers)}))}window.onload=async()=>{cleanupOldRooms(),setupSidebarBackHandler(),setupVisibilityAttention(),resetWebsiteData();const e=localStorage.getItem("notifications_enabled");notificationsEnabled="true"===e,showScreen("authScreen")},window.addEventListener("popstate",(e=>{const t=e.state?.screen;if(!t||"authScreen"===t)return alert("üö´ Can't return to login screen."),void history.pushState({screen:currentScreen},"");showScreen(t)}));let lastImageTime=0;function uploadImage(e){const t=Date.now();if(t-lastImageTime<1e4)return void alert("üïí Please wait 10 seconds before sending another image.");lastImageTime=t;const n=e.files[0];if(!n||n.size>2097152)return void alert("‚ùå Image must be under 2MB");const o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1],t=db.ref().push().key;db.ref(`rooms/${roomCode}/messages/${t}`).set({imageBase64:e,sender:username,senderId:clientId,timestamp:Date.now()})},o.readAsDataURL(n)}async function fetchProfile(e){const t=await db.ref(`auth/${e}`).get();return t.exists()?t.val():null}function validateStaticRoomPassword(){const e=document.getElementById("staticPasswordInput").value.trim();e?db.ref(`gr8stg/${STATIC_ROOM}`).get().then((t=>{if(!t.exists())return void alert("Room password not set. Cannot join.");const n=t.val();e===n?(roomCode=STATIC_ROOM,startChat()):(document.getElementById("passwordError").innerText="Incorrect password",document.getElementById("passwordError").style.display="block")})).catch((e=>{console.error(e),alert("Error connecting to server. Try again later.")})):alert("Please enter the password.")}function listenForPauseState(){db.ref(`roomStates/${roomCode}/paused`).on("value",(e=>{const t=e.exists()&&!0===e.val();document.getElementById("pausedOverlay").style.display=t?"block":"none"}))}const spamTimestamps=[];async function sendMessage(){const e=await db.ref(`roomStates/${roomCode}/paused`).get(),t=await db.ref(`muted/${roomCode}/${sanitizeUsername(username)}`).get();if(t.exists()){const e=t.val();if(("object"==typeof e&&e.muteUntil?e.muteUntil:e)>Date.now())return void alert("‚õî You are muted.")}if(e.exists()&&!0===e.val()&&"dev"!==role)return void alert("Room is currently paused.");const n=document.getElementById("msgInput"),o=n.value.trim();if(!o||isBlocked)return;const s=Date.now(),a=o.toLowerCase();if(swearWords.some((e=>a.includes(e))))return void alert("‚ö†Ô∏è Please keep the chat respectful.");spamTimestamps.push(s);if(spamTimestamps.filter((e=>s-e<7e3)).length>5)return isBlocked=!0,n.disabled=!0,n.placeholder="‚õî You're blocked for spamming (30s)",alert("‚õî You‚Äôve been muted for spamming. Please wait 30 seconds."),void setTimeout((()=>{isBlocked=!1,n.disabled=!1,n.placeholder="Type a message...",spamTimestamps.length=0}),3e4);if(o.match(/(.)\1{14,}/))return void alert("‚ö†Ô∏è No spamming allowed.");const r=localStorage.getItem("avatar_base64")||"",i=db.ref().push().key;db.ref(`rooms/${roomCode}/messages/${i}`).set({msg:o,sender:username,senderId:clientId,avatarBase64:r,timestamp:s}),n.value="",sendTyping(!0),lastActivity=s}function listenForMessages(){const e=db.ref(`rooms/${roomCode}/messages`),t=e.limitToLast(MAX_MESSAGES);userListReady=!0,t.on("child_added",(e=>{const t=e.val(),{senderId:n}=t,o=n===clientId;if(!userListReady)return pendingMessages.forEach((({data:e,sent:t,key:n})=>{addMessage(e,t,n)})),void(pendingMessages=[]);t.audioUrl,t.audioBase64;if(addMessage(t,o,e.key),roomCode!==STATIC_ROOM&&t.sender,o||(sound.play(),flagPageAttention()),notificationsEnabled&&!o&&"granted"===Notification.permission){const e=t.msg||(t.audioBase64?"[Voice Message]":t.imageBase64?"[Image]":"[Unknown]");new Notification(`üí¨ ${t.sender}`,{body:e,icon:"https://upload.wikimedia.org/wikipedia/commons/8/8c/Speech_bubble_icon.svg"})}})),e.once("value").then((e=>{const t=e.val(),n=Object.keys(t||{});if(n.length>MAX_MESSAGES){const e=n.length-MAX_MESSAGES;n.sort(((e,n)=>t[e].timestamp-t[n].timestamp)).slice(0,e).forEach((e=>{db.ref(`rooms/${roomCode}/messages/${e}`).remove()}))}})),db.ref(`rooms/${roomCode}/messages`).on("child_removed",(e=>{const t=e.key,n=document.querySelector(`[data-msg-id="${t}"]`);n&&n.remove()}))}function stackNotification(e,t){notificationStack.push({sender:e,content:t}),clearTimeout(notificationTimer),notificationTimer=setTimeout((()=>{showStackedNotification(),notificationStack=[]}),1e3)}function showStackedNotification(){if(!notificationStack.length||"granted"!==Notification.permission)return;const e=[...new Set(notificationStack.map((e=>e.sender)))],t=roomCode||"unknown",n=1===e.length?`You got a message from ${e[0]} in room ${t}: ${notificationStack[0].content}`:`You got messages from ${e.join(", ")} in room ${t}`;setTimeout((()=>{new Notification("New Chat Message",{body:n,icon:"https://upload.wikimedia.org/wikipedia/commons/8/8c/Speech_bubble_icon.svg"})}),100)}async function addMessage(e,t,n=null){const{msg:o,sender:s,senderId:a,timestamp:r,audioUrl:i,audioBase64:d,imageBase64:l}=e,c=sanitizeUsername(s),m=document.createElement("div");if("system"===e.sender){const t=document.createElement("div");t.className="system-msg",t.dataset.msgId=n||e.timestamp,t.dataset.timestamp=e.timestamp,t.style.textAlign="center",t.style.fontSize="0.8rem",t.style.color="#aaa",t.style.margin="6px auto",t.innerText=e.msg;const o=document.getElementById("messages");o.appendChild(t);const s=Array.from(o.children);return s.sort(((e,t)=>(+e.dataset.timestamp||0)-(+t.dataset.timestamp||0))),o.innerHTML="",s.forEach((e=>o.appendChild(e))),void(o.scrollTop=o.scrollHeight)}m.classList.add("msg",t?"sent":"received"),m.style.position="relative",n&&(m.dataset.msgId=n);const u=new Date(r).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=getRoleTag(c),g=await fetchAvatar(c),f=`${g?`<img src="data:image/png;base64,${g}" style="width:24px;height:24px;border-radius:50%;margin-right:6px;vertical-align:middle;">`:""}<span class="sender-name">${s} ${p}</span>`,y=o?.replace(new RegExp(`@${username}\\b`,"gi"),'<span style="color:#ff4081;">@$&</span>');let h=`${f}<br>`;if(i)h+=`<audio controls src="${i}" style="width:100%; max-width:100%; margin-top:5px;"></audio>`;else if(d){h+=`<audio controls src="${`data:audio/webm;base64,${d}`}" style="width:100%; max-width:100%; margin-top:5px;"></audio>`}else if(l){h+=`<img src="${`data:image/png;base64,${l}`}" style="max-width:80%;height:auto;margin-top:5px;border-radius:10px;" />`}else{h+=`<div>${y.replace(/(https?:\/\/[^\s]+)/g,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer" style="color:#0ff;">${e}</a>`))}</div>`}h+=`<small>${u}</small>`,m.innerHTML=h;const b=document.createElement("div");b.className="reaction-box",b.style.marginTop="4px",b.style.fontSize="16px",m.appendChild(b);const v=document.createElement("div");v.className="reaction-tray";let w,I;if(v.innerHTML=["‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üëé","üíÄ","ü§Ø"].map((e=>`<button>${e}</button>`)).join(""),v.style.display="none",v.style.position="absolute",v.style.background="#222",v.style.padding="6px",v.style.borderRadius="10px",v.style.fontSize="18px",v.style.top="-45px",v.style.left="0px",v.style.zIndex="10",v.style.maxWidth="160px",v.style.minWidth="120px",v.style.whiteSpace="normal",v.style.display="grid",v.style.gridTemplateColumns="repeat(auto-fill, minmax(32px, 1fr))",v.style.gap="4px",v.style.boxShadow="0 2px 6px rgba(0,0,0,0.5)",Array.from(v.children).forEach((e=>{e.style.cursor="pointer",e.onclick=t=>{t.stopPropagation();const o=e.textContent;reactToMessage(n,o)}})),Array.from(v.children).forEach((e=>{e.style.width="32px",e.style.height="32px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.fontSize="20px"})),m.appendChild(v),v.style.display="none",m.addEventListener("mouseenter",(()=>{w=setTimeout((()=>{v.style.display="inline-block"}),1500)})),m.addEventListener("mouseleave",(()=>{clearTimeout(w),v.style.display="none"})),m.addEventListener("touchstart",(()=>{I=setTimeout((()=>{v.style.display="inline-block"}),1500)})),m.addEventListener("touchend",(()=>clearTimeout(I))),n&&db.ref(`rooms/${roomCode}/messages/${n}/reactions`).on("value",(e=>{if(!e.exists())return void(b.innerHTML="");const t=e.val();let n="";Object.entries(t).forEach((([e,t])=>{Array.isArray(t)&&t.length>0&&(n+=`<span style="margin-right:6px;">${e} ${t.length}</span>`)})),b.innerHTML=n})),["dev","admin","moderator"].includes(role)){let e=0;m.addEventListener("click",(()=>{e++,3===e&&confirm("Delete this message?")&&(db.ref(`rooms/${roomCode}/messages/${n}`).remove(),m.remove()),setTimeout((()=>e=0),1500)}))}const $=document.getElementById("messages");$.appendChild(m),$.scrollTop=$.scrollHeight}function cleanupOldRooms(){db.ref("rooms").once("value").then((e=>{const t=e.val();if(!t)return;const n=Date.now();for(const e in t){if(e===STATIC_ROOM)continue;n-(t[e].created||0)>12e4&&db.ref("rooms/"+e).remove()}db.ref("antispam").once("value").then((e=>{const t=e.val();if(t)for(const e in t)e!==STATIC_ROOM&&db.ref(`antispam/${e}`).remove()})),db.ref("antispamBlocked").once("value").then((e=>{const t=e.val();if(t)for(const e in t)e!==STATIC_ROOM&&db.ref(`antispamBlocked/${e}`).remove()}))}))}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("msgInput");e&&e.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),sendMessage())}))}));const screenHistory=[];let currentScreen=null;function showScreen(e){currentScreen&&"authScreen"!==currentScreen&&(screenHistory.push(currentScreen),history.pushState({screen:e},"")),currentScreen=e,["usernameScreen","roomChoiceScreen","codeEntryScreen","chatScreen","passwordScreen","profileScreen","profileViewer","authScreen","editProfileScreen","mainApp"].forEach((e=>{document.getElementById(e).style.display="none"})),document.getElementById(e).style.display="flex"}function genRoomCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="0123456789",n=(e,t)=>Array.from({length:t},(()=>e[Math.floor(Math.random()*e.length)])).join("");return n(t,3)+n(e,3)+n(t,2)+n(e,2)}function startInactivityTimer(){setInterval((()=>{Date.now()-lastActivity>3e5&&roomCode!==STATIC_ROOM&&(db.ref("rooms/"+roomCode).update({active:!1}),alert("Session expired."),location.reload())}),3e4)}function setupSidebarBackHandler(){window.addEventListener("popstate",(()=>{const e=document.getElementById("userSidebar");e?.classList.contains("show")&&e.classList.remove("show")}))}function toggleSidebar(){const e=document.getElementById("userSidebar");e.classList.contains("show")?(e.classList.remove("show"),history.state?.sidebarOpen&&history.back()):(e.classList.add("show"),history.pushState({sidebarOpen:!0},""))}function setupVisibilityAttention(){let e=0,t=document.title;document.addEventListener("visibilitychange",(()=>{document.hidden||(document.title=t,e=0)})),window.flagPageAttention=function(){document.hidden&&(e++,document.title=`(${e}) New message ‚Ä¢ ${t}`)}}function tryEditProfile(){showScreen("editProfileScreen")}async function submitEditProfile(){const e=document.getElementById("oldPasswordInput").value,t=document.getElementById("newPasswordInput").value,n=document.getElementById("editBioInput").value.trim(),o=document.getElementById("editProfileError");if(!e)return o.innerText="Please enter your current password.",void(o.style.display="block");const s=sanitizeUsername(username),a=await db.ref(`auth/${s}`).get();if(!a.exists())return o.innerText="Profile not found.",void(o.style.display="block");const r=a.val();if(await sha256(e)!==r.passwordHash)return o.innerText="Incorrect current password.",void(o.style.display="block");const i={};if(t){const e=await sha256(t);i.passwordHash=e}n!==r.description&&(i.description=n);const d=Date.now();if(d-(r.lastChanged||0)>864e5&&confirm("Do you want to change your username? (only once per 24h)")){const e=prompt("Enter your new username:");e&&e.trim()&&(i.username=e.trim(),i.usernameHistory=(r.usernameHistory||[]).concat(e.trim()),i.lastChanged=d)}i.username&&i.username!==r.username?(await db.ref(`auth/${sanitizeUsername(i.username)}`).set({...r,...i}),await db.ref(`auth/${s}`).remove(),username=i.username):await db.ref(`auth/${s}`).update(i),alert("‚úÖ Profile updated! Please reload."),location.reload()}function cancelEditProfile(){document.getElementById("editProfileScreen").style.display="none",showScreen("chatScreen")}let previousUsers=[],previousUserKeys=new Set;const cachedOnlineStatus={},userStatusMap={};function listenForUserList(){db.ref(`users/${roomCode}`).on("value",(async e=>{if(!e.exists())return;const t=e.val();for(const e in previousUsers)t[e]||(t[e]=previousUsers[e]);renderUserLists(t),previousUsers=t,await loadRoomRoles(),renderUserLists(t)}))}function trackPresence(){if(!username||!roomCode)return;const e=sanitizeUsername(username),t=db.ref(`users/${roomCode}/${e}`),n={username:username,avatarBase64:avatarBase64||"",description:userDescription||"",online:!0,lastOnline:firebase.database.ServerValue.TIMESTAMP};t.once("value").then((e=>{const o=e.val()?.online;t.set(n).then((()=>{if(updateOnlineIndicator(),!o){const e=db.ref().push().key;db.ref(`rooms/${roomCode}/messages/${e}`).set({msg:`${username} is online`,sender:"system",senderId:"system",timestamp:Date.now()})}t.onDisconnect().update({online:!1,lastOnline:Date.now()})}))}))}function uploadSidebarAvatar(e){if(!e.files.length)return;const t=e.files[0],n=new FileReader;n.onloadend=async()=>{const e=n.result.split(",")[1];document.getElementById("sidebarAvatarPreview").src=n.result,document.getElementById("sidebarAvatarPreview").style.display="block";try{const t=sanitizeUsername(username);await db.ref(`auth/${t}/avatarBase64`).set(e),alert("‚úÖ Profile picture updated!")}catch(e){console.error(e),alert("‚ö†Ô∏è Failed to update avatar.")}},n.readAsDataURL(t)}function muteUser(e,t){const n=Date.now()+60*t*1e3;db.ref(`muted/${roomCode}/${sanitizeUsername(e)}`).set({muteUntil:n}).then((()=>{alert(`${e} muted for ${t} minutes.`),addSystemMessage(`${e} was muted for ${t} minutes`)}))}function unmuteUser(e){if(!isRoomAdmin)return alert("Admins only.");db.ref(`muted/${roomCode}/${sanitizeUsername(e)}`).remove()}function updateOnlineIndicator(){const e=document.getElementById("onlineStatus");e.innerText="‚óè Online",e.style.color="#00ff88"}function viewProfile(e){db.ref(`auth/${e}`).get().then((e=>{if(!e.exists())return alert("Profile not found.");const t=e.val(),n=`\nName: ${t.username}\nDescription: ${t.description||"No bio set"}\nUsername History: ${(t.usernameHistory||[]).join(", ")||"No changes yet"}\nLast Changed: ${t.lastChanged?new Date(t.lastChanged).toLocaleString():"Unknown"}\n    `.trim();document.getElementById("profileContent").innerText=n,document.getElementById("profileViewer").style.display="block"}))}function initUsernameFlow(){const e=localStorage.getItem("chat_username");e?(username=e,document.getElementById("namePreview").innerText=username,showScreen("mainApp"),history.replaceState({screen:"mainApp"},"")):showScreen("profileScreen")}function closeProfile(){document.getElementById("profileViewer").style.display="none"}function resetWebsiteData(){try{const e=localStorage.getItem("notifications_enabled");localStorage.clear(),sessionStorage.clear(),sessionStorage.removeItem("2048_user"),sessionStorage.removeItem("2048_avatar"),e&&localStorage.setItem("notifications_enabled",e)}catch(e){}username&&roomCode||(username=null,roomCode=null,isRoomAdmin=!1,pendingMessages=[],clientId="_"+Math.random().toString(36).substr(2,9))}function addAnnouncement(){const e=prompt("Enter Announcement Text:");e&&db.ref(`rooms/${roomCode}/announcement`).set({text:e,by:username,timestamp:Date.now()})}function listenForAnnouncement(){db.ref(`rooms/${roomCode}/announcement`).on("value",(e=>{const t=e.val();if(!t)return void(document.getElementById("announcementArea").innerText="");document.getElementById("announcementArea").innerText=`${t.text}`}))}function muteUser(e,t){const n=Date.now()+60*t*1e3;db.ref(`muted/${roomCode}/${sanitizeUsername(e)}`).set({muteUntil:n}).then((()=>{alert(`${e} muted for ${t} minutes.`)}))}function deleteUserMessages(e){db.ref(`rooms/${roomCode}/messages`).orderByChild("sender").equalTo(e).get().then((t=>{t.forEach((e=>{db.ref(`rooms/${roomCode}/messages/${e.key}`).remove()})),alert(`Messages by ${e} deleted.`)}))}function pauseRoom(e){db.ref(`rooms/${roomCode}/paused`).on("value",(e=>{const t=e.val();document.getElementById("pausedOverlay").style.display=t?"block":"none"}))}function canPerformAction(e){return"dev"===role||("mute"===e?"admin"===role||"moderator"===role||"mod"===role:("deleteMessage"===e||"promote"===e||"promote"===e)&&"admin"===role)}setInterval(updateOnlineIndicator,3e3),document.getElementById("announcementArea").addEventListener("click",(e=>{3===e.detail&&isRoomAdmin&&confirm("Remove Announcement?")&&db.ref(`rooms/${roomCode}/announcement`).remove()})),document.getElementById("msgInput").addEventListener("input",(()=>{const e=document.getElementById("msgInput");e.style.border=n?"2px solid red":"";const t=e.value.toLowerCase(),n=swearWords.some((e=>t.includes(e)));n?(e.style.border="2px solid red",sendBtn.disabled=!0):(e.style.border="",e.style.border=n?"2px solid red":"")}));const html=Object.values(roomUsers).map((e=>{const t=sanitizeUsername(e.username),n=[];return t!==sanitizeUsername(username)&&(canPerformAction("mute")&&(n.push(`<button onclick="muteUser('${t}', 5)">Mute 5m</button>`),n.push(`<button onclick="muteUser('${t}', 10)">Mute 10m</button>`)),canPerformAction("deleteMessage")&&n.push(`<button onclick="deleteUserMessages('${t}')">Delete Messages</button>`),"dev"===role?(n.push(`<button onclick="promoteToModerator('${t}')">Promote to Moderator</button>`),n.push(`<button onclick="promoteToAdmin('${t}')">Promote to Admin</button>`)):"admin"===role&&n.push(`<button onclick="promoteToModerator('${t}')">Promote to Moderator</button>`)),`\n    <li style="color:#0ff;">\n      ${e.username} ${getRoleTag(sanitizeUsername(e.username))}\n      <div id="userOptions-${t}" class="user-options" style="display:none;">\n        ${n.join("")}\n      </div>\n      <button onclick="toggleUserOptions('${t}')" style="background:none;border:none;color:#0ff;font-size:0.8rem;">‚öôÔ∏è</button>\n    </li>`})).join("");function promoteToModerator(e){const t=sanitizeUsername(e);if(isProtected(t))return alert("üö´ Cannot promote Developers.");"dev"===role||"admin"===role?db.ref(`moderators/${roomCode}/${t}`).set(!0).then((()=>{alert(`${e} promoted to Moderator!`),addSystemMessage(`${e} was promoted to Moderator`)})):alert("Only Devs or Admins can promote.")}function promoteToAdmin(e){const t=sanitizeUsername(e);if(isProtected(t))return alert("üö´ Cannot promote Developers.");"dev"===role?db.ref(`admins/${roomCode}/${t}`).set(!0).then((()=>{alert(`${e} promoted to Admin!`),addSystemMessage(`${e} was promoted to Admin`)})):alert("Only Devs can promote to Admin.")}function toggleUserOptions(e){"dev"!==role&&"admin"!==role||controls.push(`<button onclick="demoteUser('${safeName}')">Demote</button>`);const t=document.getElementById(`userOptions-${e}`);"none"===t.style.display?t.style.display="block":t.style.display="none"}function demoteUser(e){if(isProtected(e))return alert("üö´ You cannot demote a Developer.");"dev"===role?(db.ref(`admins/${roomCode}/${e}`).remove(),db.ref(`moderators/${roomCode}/${e}`).remove(),alert(`${e} demoted to user.`),addSystemMessage(`${e} was demoted`)):"admin"===role?(db.ref(`moderators/${roomCode}/${e}`).remove(),alert(`${e} demoted to user.`),addSystemMessage(`${e} was demoted`)):alert("üö´ Only Admins or Devs can demote.")}function getRoleTag(e){const t=sanitizeUsername(e);return globalDevs.includes(t)?'<span style="color:darkblue;">[Dev]</span>':roomAdmins.includes(t)?'<span style="color:darkred;">[Admin]</span>':roomModerators.includes(t)?'<span style="color:darkgreen;">[Mod]</span>':""}async function loadRoomRoles(){const e=sanitizeUsername(username);globalDevs=[],roomAdmins=[],roomModerators=[];(await db.ref("auth").get()).forEach((e=>{"dev"===e.val().role&&globalDevs.push(e.key)}));const t=await db.ref(`admins/${roomCode}`).get();t.exists()&&t.forEach((e=>roomAdmins.push(e.key)));const n=await db.ref(`moderators/${roomCode}`).get();n.exists()&&n.forEach((e=>roomModerators.push(e.key))),globalDevs.includes(e)?role="dev":roomAdmins.includes(e)?role="admin":roomModerators.includes(e)?role="moderator":role="user"}async function renderUserLists(e){roomUsers=e;const t=sanitizeUsername(username),n=["dev","admin","moderator","mod"].includes(role);document.getElementById("adminControlsSection").style.display=n?"block":"none";const o=Object.entries(e).map((async([e,t])=>{const n=sanitizeUsername(t.username||e),o=await fetchAvatar(n);return`<li>${o?`<img src="data:image/png;base64,${o}" style="width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle;">`:""} ${t.online?'<span style="color:#0f0;font-size:1rem;">‚óè</span>':'<span style="color:red;font-size:1rem;">‚óè</span>'} <span style="cursor:pointer;color:#00ffc3;" onclick="viewProfile('${n}')">${t.username||e}</span> ${getRoleTag(n)}</li>`}));if(document.getElementById("userList").innerHTML=(await Promise.all(o)).join(""),!n)return;const s=Object.entries(e).map((async([e,n])=>{const o=sanitizeUsername(n.username||e);if(o===t)return"";const s=globalDevs.includes(o),a=await fetchAvatar(o),r=a?`<img src="data:image/png;base64,${a}" style="width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle;">`:"",i=n.online?'<span style="color:#0f0;font-size:1rem;">‚óè</span>':'<span style="color:red;font-size:1rem;">‚óè</span>',d=[];return s||(["mod","moderator","admin","dev"].includes(role)&&(d.push(`<button onclick="muteUser('${o}', 1)">Mute 1m</button>`),d.push(`<button onclick="muteUser('${o}', 5)">Mute 5m</button>`),d.push(`<button onclick="muteUser('${o}', 10)">Mute 10m</button>`)),"dev"===role?(d.push(`<button onclick="promoteToModerator('${o}')">+Mod</button>`),d.push(`<button onclick="promoteToAdmin('${o}')">+Admin</button>`),d.push(`<button onclick="demoteUser('${o}')">Demote</button>`)):"admin"===role&&(d.push(`<button onclick="promoteToModerator('${o}')">+Mod</button>`),d.push(`<button onclick="demoteUser('${o}')">Demote</button>`))),`\n      <li style="margin-bottom:10px;">\n        ${r} ${i} üîß ${n.username||e} ${getRoleTag(o)}<br/>\n        <div style="margin-top:5px;">${d.join(" ")}</div>\n      </li>`}));document.getElementById("adminUserList").innerHTML=(await Promise.all(s)).join("")}function updateAnnouncementVisibility(){const e=document.getElementById("addAnnouncementBtn");"admin"===role||"dev"===role?e.style.display="block":e.style.display="none"}async function fetchAvatar(e){if(userAvatars[e])return userAvatars[e];const t=await db.ref(`auth/${e}`).get();return t.exists()&&t.val().avatarBase64?(userAvatars[e]=t.val().avatarBase64,userAvatars[e]):null}function sendTyping(){const e=sanitizeUsername(username),t=Date.now();db.ref(`typing/${roomCode}/${e}`).set(t),typingTimeout&&clearTimeout(typingTimeout),typingTimeout=setTimeout((()=>{db.ref(`typing/${roomCode}/${e}`).remove()}),500)}function listenForTyping(){db.ref(`typing/${roomCode}`).on("value",(e=>{const t=document.getElementById("typing");if(!e.exists())return t.innerText="";const n=Date.now(),o=Object.entries(e.val()).filter((([e,t])=>e!==sanitizeUsername(username)&&n-t<5e3)).map((([e])=>e));t.innerText=o.length?`${o.join(", ")} is typing...`:""}))}function watchMuteStatus(){const e=db.ref(`muted/${roomCode}/${sanitizeUsername(username)}`);let t;e.on("value",(n=>{clearInterval(t);const o=document.getElementById("msgInput");if(!n.exists())return o.disabled=!1,void(o.placeholder="Type a message...");const s=n.val(),a="object"==typeof s&&s.muteUntil?s.muteUntil:s;a>Date.now()?(o.disabled=!0,o.placeholder="‚õî You are muted.",t=setInterval((()=>{Date.now()>a&&e.remove()}),3e3)):(o.disabled=!1,o.placeholder="Type a message...",e.remove())}))}function isProtected(e){return globalDevs.includes(e)}function addSystemMessage(e){const t=document.createElement("div");t.style.textAlign="center",t.style.fontSize="0.8rem",t.style.color="#aaa",t.style.margin="6px auto",t.innerText=e,document.getElementById("messages").appendChild(t),document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight}function reactToMessage(e,t){const n=sanitizeUsername(username),o=db.ref(`rooms/${roomCode}/messages/${e}/reactions`);o.once("value").then((e=>{const s=e.val()||{},a={};for(const[e,t]of Object.entries(s))a[e]=(t||[]).filter((e=>e!==n));s[t]&&s[t].includes(n)||(a[t]||(a[t]=[]),a[t].push(n)),o.set(a)}))}function startSidebarSyncLoop(){setInterval((async()=>{if(!roomCode)return;const e=await db.ref(`users/${roomCode}`).get();if(e.exists()){renderUserLists(e.val())}}),5e3)}function gotoRoomMenu(){document.getElementById("namePreview").innerText=username,showScreen("roomChoiceScreen")}function redirectTo2048(){const e=localStorage.getItem("2048_token");localStorage.getItem("2048_user")&&e?window.location.href=`https://2048.webuserent.org?token=${encodeURIComponent(e)}`:alert("‚ùå You must be logged in.")}function redirectToBreakout(){const e=localStorage.getItem("2048_token");localStorage.getItem("2048_user")&&e?window.location.href=`https://breakout.webuserent.org?token=${encodeURIComponent(e)}`:alert("‚ùå You must be logged in.")}function goBackSafe(){for(;screenHistory.length>0;){const e=screenHistory.pop();if("authScreen"!==e)return void showScreen(e)}}